# 产品需求文档 (PRD): PostgreSQL 到 Go 类型映射工具

## 1. 概述

### 1.1 项目背景

在使用 goctl 工具生成 PostgreSQL 数据库的 Go 代码时，遇到类型不匹配的问题。goctl 内置的类型映射机制无法完全满足项目中自定义类型（如 ENUM 类型和 pgvector 扩展类型）的需求，需要一个脚本/工具来映射常见的 PostgreSQL 类型到 Go 类型。

### 1.2 目标

开发一个工具来扩展 goctl 的类型映射能力，使其能够正确处理项目中使用的自定义 PostgreSQL 类型，包括 ENUM 类型和 pgvector 扩展的 VECTOR 类型。

### 1.3 成功指标

- 工具能够正确处理所有自定义 PostgreSQL 类型
- 生成的 Go 代码能够通过编译且类型匹配正确
- 工具易于使用和维护
- 能够与现有的 goctl 工作流程无缝集成

## 2. 目标用户

### 2.1 主要用户

- Go 后端开发人员
- 使用 go-zero 框架的开发团队
- 需要与 PostgreSQL 数据库交互的项目

### 2.2 用户画像

- **开发者张三**：有 3 年 Go 开发经验，使用 go-zero 框架构建后端服务，需要与 PostgreSQL 数据库交互，经常使用 goctl 生成模型代码。

## 3. 功能需求

### 3.1 核心功能

#### 3.1.1 PostgreSQL 类型识别

- 能够解析 PostgreSQL 数据库 schema
- 识别自定义 ENUM 类型
- 识别 pgvector 扩展的 VECTOR 类型
- 识别 JSONB 类型

#### 3.1.2 类型映射配置

- 根据 SQL schema 中的类型自动更新 goctl.yaml 配置文件
- 支持 ENUM 类型映射为 Go string 类型
- 支持 VECTOR 类型映射为适当的 Go 类型
- 保持现有类型映射不变

#### 3.1.3 配置文件管理

- 读取现有的 goctl.yaml 配置文件
- 更新类型映射部分而不影响其他配置
- 生成备份文件以防配置损坏

### 3.2 用户故事

#### 故事 1: 开发者使用工具处理自定义类型

作为开发者，我希望使用这个工具自动处理 PostgreSQL 自定义类型，这样我就不用手动编辑 goctl.yaml 文件来添加类型映射。

#### 故事 2: 工具正确识别 ENUM 类型

作为开发者，我希望工具能够正确识别数据库中的 ENUM 类型并生成相应的映射配置，这样生成的 Go 代码就能正确使用这些类型。

#### 故事 3: 工具处理 pgvector 类型

作为开发者，我希望工具能够正确处理 pgvector 扩展的 VECTOR 类型，这样我就可以在 Go 代码中使用向量相似度搜索功能。

## 4. 非功能需求

### 4.1 性能需求

- 工具应在 5 秒内完成类型识别和配置文件更新
- 内存使用不超过 100MB

### 4.2 安全需求

- 工具不应修改除 goctl.yaml 之外的任何文件
- 应提供备份机制以防配置文件损坏
- 不应存储任何数据库连接信息

### 4.3 可用性需求

- 工具应提供清晰的命令行界面
- 应提供详细的日志输出以帮助调试
- 应提供帮助文档说明如何使用

### 4.4 兼容性需求

- 工具应兼容 goctl 1.6.5 及以上版本
- 应支持常见的 PostgreSQL 版本（10+）
- 应在 Linux、macOS 和 Windows 上都能运行

## 5. 技术需求

### 5.1 技术栈

- Rust 语言
- PostgreSQL 数据库连接库
- YAML 解析库

### 5.2 系统架构

```
+------------------+     +-------------------+     +------------------+
|  PostgreSQL DB   | --> |  Type Detection   | --> |  YAML Updater    |
+------------------+     +-------------------+     +------------------+
                                |                           |
                                v                           v
                        +------------------+     +------------------+
                        |  ENUM Handler    |     |  goctl.yaml      |
                        +------------------+     +------------------+
```

### 5.3 接口设计

#### 命令行接口

```bash
# 基本用法
pg2sqlx --schema-file=001_init_schema.sql --config=goctl.yaml

# 指定输出文件
pg2sqlx --schema-file=001_init_schema.sql --config=goctl.yaml --output=goctl_updated.yaml
```

### 5.4 数据模型

#### ENUM 类型映射

```yaml
model:
  types_map:
    emotion_type:
      null_type: sql.NullString
      type: string
    memory_type:
      null_type: sql.NullString
      type: string
```

#### VECTOR 类型映射

```yaml
model:
  types_map:
    vector:
      null_type: sql.NullString
      type: string
      pkg: github.com/pgvector/pgvector-go
```

## 6. 实施计划

### 6.1 第一阶段：核心功能开发 (2 周)

- 实现 PostgreSQL schema 解析功能
- 实现 ENUM 类型识别和映射
- 实现 YAML 配置文件更新功能

### 6.2 第二阶段：扩展功能开发 (1 周)

- 实现 VECTOR 类型处理
- 实现 JSONB 类型优化
- 添加备份和恢复功能

### 6.3 第三阶段：测试和完善 (1 周)

- 进行全面测试
- 修复发现的问题
- 编写文档和使用示例

## 7. 风险评估

### 7.1 技术风险

- PostgreSQL 版本兼容性问题
- goctl 版本更新导致的 API 变化
- 复杂 ENUM 类型处理的边界情况

### 7.2 时间风险

- 类型识别算法比预期复杂
- 与现有工具集成遇到困难

### 7.3 缓解措施

- 使用广泛兼容的 PostgreSQL 连接库
- 编写全面的测试用例
- 提供详细的文档和使用示例

## 8. 验收标准

### 8.1 功能验收

- [ ] 工具能够正确识别所有自定义 ENUM 类型
- [ ] 工具能够正确处理 VECTOR 类型
- [ ] 生成的配置文件能使 goctl 正确生成代码
- [ ] 工具备份机制正常工作

### 8.2 性能验收

- [ ] 工具执行时间不超过 5 秒
- [ ] 内存使用不超过 100MB

### 8.3 用户体验验收

- [ ] 提供清晰的帮助信息
- [ ] 错误信息易于理解
- [ ] 日志输出详细且有用
